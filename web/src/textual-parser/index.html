<!doctype html>
<html>

<head>
    <title>Eberban Textual Parser v2</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf8">
    <meta name="viewport" content="initial-scale=1.0,width=device-width,user-scalable=0,viewport-fit=cover" />
    <link rel="icon" type="image/png" sizes="200x200" href="/icon.png">
    <style>
        form,
        select {
            margin: 4px 0
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</head>

<body>
    <form id="form1" name="form1" method="post" action="" style="width:100%">
        <textarea id="input_textarea" style="width:100%" rows="8" spellcheck="false" autofocus></textarea>
    </form>
    <hr />

    <div id="parser_error_box"
        style="display:block; overflow: scroll; border: solid 1px; padding: 10px; background-color: #FFAAAA;">
        <pre style="white-space: pre-wrap;"><code id="parse_error"></code></pre>
    </div>

    <div id="parser_warnings_box"
        style="display:block; overflow: scroll; border: solid 1px; padding: 10px; background-color: #FFFFAA;">
        <pre style="white-space: pre-wrap;"><code id="parse_warnings"></code></pre>
    </div>

    <div
        style="display:block; overflow: scroll; border: solid 1px; padding: 10px; background-color: #DDDDFF;">
        <pre style="white-space: pre-wrap;"><code id="parse_result"></code></pre>
    </div>

    

    <script type="module">
        import * as parser from "../grammar/eberban.peggy.js";
        import { GrammarError } from "peggy";

        window.onload = run_parser();

        $('#input_textarea').bind("keyup",
            function (e) {
                run_parser();
            }
        );

        function run_parser() {
            try {
                var input = $('#input_textarea').val();
                var result = parser.parse(input, { grammarSource: "form"});

                if(result?.warnings != undefined) {
                    var warnings = "";

                    for (var warn of result.warnings) {
                        var err = new GrammarError(warn.message, warn.location);
                        err.problems[0][0] = "warning";

                        warnings += err.format([
                            { source: 'form', text: input }
                        ]);
                        warnings += "\n\n";
                    }

                    result.warnings = undefined;

                    $('#parse_warnings').text(warnings);
                    $('#parser_warnings_box').show();
                } else {
                    $('#parser_warnings_box').hide();
                }

                $('#parse_result').text(JSON.stringify(result, null, 4));
                $('#parser_error_box').hide();


            } catch (e) {
                console.log(JSON.stringify(e));
                if (typeof e.format === "function") {
                    var err_message = e.format([
                    { source: 'form', text: input }
                    ]);
                } else {
                    var err_message = e.toString();
                }
                $('#parse_error').text(err_message);
                $('#parser_error_box').show();
            }

            
        }

    </script>

</body>